import "allocator/arena";
// TODO: Why cannot import from index?
// import { BSONEncoder, BSONDecoder } from "./bson";
import { BSONEncoder } from "./bson/encoder";
import { BSONDecoder, ThrowingBSONHandler } from "./bson/decoder";
import { near } from "./near";

declare function log(str: string): void;

// Runtime functions
declare function return_value(value_ptr: u32): void;
declare function input_read_len(): u32;
declare function input_read_into(ptr: usize): void;

export class FooBar {
  foo: i32 = 0;
  bar: i32 = 1;
  flag: bool;
  baz: string = "123";
  foobar: Uint8Array;
  arr: Array<Array<string>>;
}

export class ContainerClass {
  foobar: FooBar;
}

export class AnotherContainerClass {
  foobar: FooBar;
}

export function doNothing(): void {}

export function add(x: i32, y: i32): i32 {
  return x + y;
}

export function getFoobar(container: ContainerClass): AnotherContainerClass {
  let result = new AnotherContainerClass();
  result.foobar = container.foobar;
  return result;
}

export function convertFoobars(foobars: Array<FooBar>): Array<ContainerClass> {
  return foobars.map<ContainerClass>(
    (it: FooBar, i: i32, arr: Array<FooBar>): ContainerClass => {
      let container = new ContainerClass();
      container.foobar = it;
      return container;
    }
  );
}

export class __near_ArgsParser_doNothing extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_ArgsParser_doNothing>;

  setNull(name: string): void {
    super.setNull(name);
  }

  pushObject(name: string): bool {
    return super.pushObject(name);
  }

  pushArray(name: string): bool {
    return super.pushArray(name);
  }
}
export function near_func_doNothing(): void {
  let bson = new Uint8Array(input_read_len());
  input_read_into(bson.buffer.data);
  let handler = new __near_ArgsParser_doNothing();
  handler.buffer = bson;
  handler.decoder = new BSONDecoder<__near_ArgsParser_doNothing>(handler);
  handler.decoder.deserialize(bson);
  doNothing();
}
export class __near_ArgsParser_add extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_ArgsParser_add>;

  __near_param_x: i32;
  __near_param_y: i32;
  setInteger(name: string, value: i32): void {
    if (name == "x") {
      this.__near_param_x = value;
      return;
    }
    if (name == "y") {
      this.__near_param_y = value;
      return;
    }

    super.setInteger(name, value);
  }
  setNull(name: string): void {
    if (name == "x") {
      this.__near_param_x = <i32>null;
      return;
    }
    if (name == "y") {
      this.__near_param_y = <i32>null;
      return;
    }

    super.setNull(name);
  }

  pushObject(name: string): bool {
    return super.pushObject(name);
  }

  pushArray(name: string): bool {
    return super.pushArray(name);
  }
}
export function near_func_add(): void {
  let bson = new Uint8Array(input_read_len());
  input_read_into(bson.buffer.data);
  let handler = new __near_ArgsParser_add();
  handler.buffer = bson;
  handler.decoder = new BSONDecoder<__near_ArgsParser_add>(handler);
  handler.decoder.deserialize(bson);
  let result = add(handler.__near_param_x, handler.__near_param_y);

  let encoder = new BSONEncoder();
  encoder.setInteger("result", result);

  return_value(near.bufferWithSize(encoder.serialize()).buffer.data);
}
export class __near_BSONHandler_ContainerClass extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_BSONHandler_ContainerClass>;
  value: ContainerClass = new ContainerClass();
  setNull(name: string): void {
    if (name == "foobar") {
      this.value.foobar = <FooBar>null;
      return;
    }

    super.setNull(name);
  }

  pushObject(name: string): bool {
    if (name == "foobar") {
      this.value.foobar = __near_decode_FooBar(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushObject(name);
  }

  pushArray(name: string): bool {
    if (name == "foobar") {
      this.value.foobar = __near_decode_FooBar(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushArray(name);
  }
}

export class __near_BSONHandler_FooBar extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_BSONHandler_FooBar>;
  value: FooBar = new FooBar();
  setInteger(name: string, value: i32): void {
    if (name == "foo") {
      this.value.foo = value;
      return;
    }
    if (name == "bar") {
      this.value.bar = value;
      return;
    }

    super.setInteger(name, value);
  }
  setString(name: string, value: String): void {
    if (name == "baz") {
      this.value.baz = value;
      return;
    }

    super.setString(name, value);
  }
  setUint8Array(name: string, value: Uint8Array): void {
    if (name == "foobar") {
      this.value.foobar = value;
      return;
    }

    super.setUint8Array(name, value);
  }
  setBoolean(name: string, value: bool): void {
    if (name == "flag") {
      this.value.flag = value;
      return;
    }

    super.setBoolean(name, value);
  }
  setNull(name: string): void {
    if (name == "foo") {
      this.value.foo = <i32>null;
      return;
    }
    if (name == "bar") {
      this.value.bar = <i32>null;
      return;
    }
    if (name == "flag") {
      this.value.flag = <bool>null;
      return;
    }
    if (name == "baz") {
      this.value.baz = <String>null;
      return;
    }
    if (name == "foobar") {
      this.value.foobar = <Uint8Array>null;
      return;
    }
    if (name == "arr") {
      this.value.arr = <Array<Array<String>>>null;
      return;
    }

    super.setNull(name);
  }

  pushObject(name: string): bool {
    if (name == "arr") {
      this.value.arr = __near_decode_Array_Array_String(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushObject(name);
  }

  pushArray(name: string): bool {
    if (name == "arr") {
      this.value.arr = __near_decode_Array_Array_String(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushArray(name);
  }
}

export class __near_BSONHandler_Array_Array_String extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_BSONHandler_Array_Array_String>;
  value: Array<Array<String>> = new Array<Array<String>>();
  pushObject(name: string): bool {
    this.value[i32(parseInt(name))] = __near_decode_Array_String(
      this.buffer,
      this.decoder.readIndex
    );
    return false;
  }
  pushArray(name: string): bool {
    this.value[i32(parseInt(name))] = __near_decode_Array_String(
      this.buffer,
      this.decoder.readIndex
    );
    return false;
  }
}

export class __near_BSONHandler_Array_String extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_BSONHandler_Array_String>;
  value: Array<String> = new Array<String>();
  setString(name: string, value: String): void {
    this.value[i32(parseInt(name))] = value;
  }
  setNull(name: string): void {
    this.value[i32(parseInt(name))] = <String>null;
  }
}

export function __near_decode_Array_String(
  buffer: Uint8Array,
  offset: i32
): Array<String> {
  let handler = new __near_BSONHandler_Array_String();
  handler.buffer = buffer;
  handler.decoder = new BSONDecoder<__near_BSONHandler_Array_String>(handler);
  handler.decoder.deserialize(buffer, offset);
  return handler.value;
}

export function __near_decode_Array_Array_String(
  buffer: Uint8Array,
  offset: i32
): Array<Array<String>> {
  let handler = new __near_BSONHandler_Array_Array_String();
  handler.buffer = buffer;
  handler.decoder = new BSONDecoder<__near_BSONHandler_Array_Array_String>(
    handler
  );
  handler.decoder.deserialize(buffer, offset);
  return handler.value;
}

export function __near_decode_FooBar(buffer: Uint8Array, offset: i32): FooBar {
  let handler = new __near_BSONHandler_FooBar();
  handler.buffer = buffer;
  handler.decoder = new BSONDecoder<__near_BSONHandler_FooBar>(handler);
  handler.decoder.deserialize(buffer, offset);
  return handler.value;
}

export function __near_decode_ContainerClass(
  buffer: Uint8Array,
  offset: i32
): ContainerClass {
  let handler = new __near_BSONHandler_ContainerClass();
  handler.buffer = buffer;
  handler.decoder = new BSONDecoder<__near_BSONHandler_ContainerClass>(handler);
  handler.decoder.deserialize(buffer, offset);
  return handler.value;
}

export class __near_ArgsParser_getFoobar extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_ArgsParser_getFoobar>;

  __near_param_container: ContainerClass;
  setNull(name: string): void {
    if (name == "container") {
      this.__near_param_container = <ContainerClass>null;
      return;
    }

    super.setNull(name);
  }

  pushObject(name: string): bool {
    if (name == "container") {
      this.__near_param_container = __near_decode_ContainerClass(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushObject(name);
  }

  pushArray(name: string): bool {
    if (name == "container") {
      this.__near_param_container = __near_decode_ContainerClass(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushArray(name);
  }
}
export function __near_encode_Array_String(
  value: Array<String>,
  encoder: BSONEncoder
): void {
  for (let i = 0; i < value.length; i++) {
    if (value[i] != null) {
      encoder.setString(near.str(i), value[i]);
    } else {
      encoder.setNull(near.str(i));
    }
  }
}
export function __near_encode_Array_Array_String(
  value: Array<Array<String>>,
  encoder: BSONEncoder
): void {
  for (let i = 0; i < value.length; i++) {
    if (value[i] != null) {
      encoder.pushArray(near.str(i));
      __near_encode_Array_String(value[i], encoder);
      encoder.popArray();
    } else {
      encoder.setNull(near.str(i));
    }
  }
}
export function __near_encode_FooBar(
  value: FooBar,
  encoder: BSONEncoder
): void {
  encoder.setInteger("foo", value.foo);
  encoder.setInteger("bar", value.bar);
  encoder.setBoolean("flag", value.flag);
  if (value.baz != null) {
    encoder.setString("baz", value.baz);
  } else {
    encoder.setNull("baz");
  }
  if (value.foobar != null) {
    encoder.setUint8Array("foobar", value.foobar);
  } else {
    encoder.setNull("foobar");
  }
  if (value.arr != null) {
    encoder.pushArray("arr");
    __near_encode_Array_Array_String(value.arr, encoder);
    encoder.popArray();
  } else {
    encoder.setNull("arr");
  }
}
export function __near_encode_AnotherContainerClass(
  value: AnotherContainerClass,
  encoder: BSONEncoder
): void {
  if (value.foobar != null) {
    encoder.pushObject("foobar");
    __near_encode_FooBar(value.foobar, encoder);
    encoder.popObject();
  } else {
    encoder.setNull("foobar");
  }
}
export function near_func_getFoobar(): void {
  let bson = new Uint8Array(input_read_len());
  input_read_into(bson.buffer.data);
  let handler = new __near_ArgsParser_getFoobar();
  handler.buffer = bson;
  handler.decoder = new BSONDecoder<__near_ArgsParser_getFoobar>(handler);
  handler.decoder.deserialize(bson);
  let result = getFoobar(handler.__near_param_container);

  let encoder = new BSONEncoder();
  if (result != null) {
    encoder.pushObject("result");
    __near_encode_AnotherContainerClass(result, encoder);
    encoder.popObject();
  } else {
    encoder.setNull("result");
  }

  return_value(near.bufferWithSize(encoder.serialize()).buffer.data);
}
export class __near_BSONHandler_Array_FooBar extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_BSONHandler_Array_FooBar>;
  value: Array<FooBar> = new Array<FooBar>();
  pushObject(name: string): bool {
    this.value[i32(parseInt(name))] = __near_decode_FooBar(
      this.buffer,
      this.decoder.readIndex
    );
    return false;
  }
  pushArray(name: string): bool {
    this.value[i32(parseInt(name))] = __near_decode_FooBar(
      this.buffer,
      this.decoder.readIndex
    );
    return false;
  }
}

export function __near_decode_Array_FooBar(
  buffer: Uint8Array,
  offset: i32
): Array<FooBar> {
  let handler = new __near_BSONHandler_Array_FooBar();
  handler.buffer = buffer;
  handler.decoder = new BSONDecoder<__near_BSONHandler_Array_FooBar>(handler);
  handler.decoder.deserialize(buffer, offset);
  return handler.value;
}

export class __near_ArgsParser_convertFoobars extends ThrowingBSONHandler {
  buffer: Uint8Array;
  decoder: BSONDecoder<__near_ArgsParser_convertFoobars>;

  __near_param_foobars: Array<FooBar>;
  setNull(name: string): void {
    if (name == "foobars") {
      this.__near_param_foobars = <Array<FooBar>>null;
      return;
    }

    super.setNull(name);
  }

  pushObject(name: string): bool {
    if (name == "foobars") {
      this.__near_param_foobars = __near_decode_Array_FooBar(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushObject(name);
  }

  pushArray(name: string): bool {
    if (name == "foobars") {
      this.__near_param_foobars = __near_decode_Array_FooBar(
        this.buffer,
        this.decoder.readIndex
      );
      return false;
    }

    return super.pushArray(name);
  }
}
export function __near_encode_ContainerClass(
  value: ContainerClass,
  encoder: BSONEncoder
): void {
  if (value.foobar != null) {
    encoder.pushObject("foobar");
    __near_encode_FooBar(value.foobar, encoder);
    encoder.popObject();
  } else {
    encoder.setNull("foobar");
  }
}
export function __near_encode_Array_ContainerClass(
  value: Array<ContainerClass>,
  encoder: BSONEncoder
): void {
  for (let i = 0; i < value.length; i++) {
    if (value[i] != null) {
      encoder.pushObject(near.str(i));
      __near_encode_ContainerClass(value[i], encoder);
      encoder.popObject();
    } else {
      encoder.setNull(near.str(i));
    }
  }
}
export function near_func_convertFoobars(): void {
  let bson = new Uint8Array(input_read_len());
  input_read_into(bson.buffer.data);
  let handler = new __near_ArgsParser_convertFoobars();
  handler.buffer = bson;
  handler.decoder = new BSONDecoder<__near_ArgsParser_convertFoobars>(handler);
  handler.decoder.deserialize(bson);
  let result = convertFoobars(handler.__near_param_foobars);

  let encoder = new BSONEncoder();
  if (result != null) {
    encoder.pushArray("result");
    __near_encode_Array_ContainerClass(result, encoder);
    encoder.popArray();
  } else {
    encoder.setNull("result");
  }

  return_value(near.bufferWithSize(encoder.serialize()).buffer.data);
}
