// References:
// https://github.com/vmg/houdini
// https://github.com/brianmario/escape_utils/blob/master/ext/escape_utils/houdini_uri_u.c
// https://github.com/brianmario/escape_utils/blob/master/ext/escape_utils/escape_utils.c
// https://github.com/brianmario/escape_utils/blob/master/ext/escape_utils/houdini.h
//
// https://github.com/JetBrains/jdk8u_nashorn/blob/master/src/jdk/nashorn/internal/runtime/URIUtils.java

import {
  HEADER_SIZE,
  CharCode
} from "./string";

@inline
export function URI_SAFE(): u8[] {
  const table: u8[] = [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1,
    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
  ];
  return table;
}

@inline
export function URL_SAFE(): u8[] {
  const table: u8[] = [
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,
    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1,
    0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  ];
  return table;
}

export function escapeUnsafe(dest: usize, source: usize, table: u8[], len: isize): bool {
  const HEX_CHARS: u8[] = [
    0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39,
    0x41, 0x42, 0x43, 0x44, 0x45, 0x46
  ];

  var hex0: u16 = CharCode.PERCENT; // %
  var i: isize = 0, org: isize, offset: usize = 0;
  while (i < len) {
    org = i;
    let ch = load<u16>(source + (i << 1), HEADER_SIZE);
    while (i < len && ch <= 127 && table[ch] != 0) {
      ++i;
      ch = load<u16>(source + (i << 1), HEADER_SIZE);
    }
    if (i > org) {
      if (!org) {
        if (i >= len) return false;
        // reallocUnsafe(dest, len * 12 / 10);
      }
      let size = <usize>(i - org) << 1;
      memory.copy(
        dest   + HEADER_SIZE + offset,
        source + HEADER_SIZE + <usize>(org << 1),
        size
      );
      offset += size;
    }
    /* escaping */
    if (i >= len) break;

    ch = load<u16>(source + (i << 1), HEADER_SIZE);
    let hex1 = <u32>HEX_CHARS[(ch >>> 4) & 0x0F] | (<u32>HEX_CHARS[ch & 0x0F] << 16);
    store<u16>(dest + offset, hex0, HEADER_SIZE + 0);
    store<u32>(dest + offset, hex1, HEADER_SIZE + 2);
    offset += 3 << 1;
    ++i;
  }
  return true;
}
